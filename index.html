<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AILEE Trust Layer | Adaptive Integrity</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Menlo:wght@400;700&display=swap" rel="stylesheet">

    <!-- External Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>

    <style>
        /* styles.css - Sleek Wood Finish Enhanced Chat Interface */

        :root {
            /* Light Wood Theme (Default) */
            --primary: #c25e00;
            --primary-hover: #e07b00;
            --bg-wood-start: #5d4037;
            --bg-wood-end: #3e2723;
            --bg-overlay: rgba(255, 255, 255, 0.05);

            --surface: rgba(255, 255, 255, 0.95);
            --surface-secondary: rgba(245, 247, 250, 0.9);
            --surface-blur: blur(12px);

            --text-main: #2d3748;
            --text-muted: #718096;
            --border-color: #e2e8f0;

            --msg-user-bg: #e0f2fe; /* Light blue */
            --msg-user-text: #1e3a8a;
            --msg-ai-bg: #f8fafc; /* Very light gray */
            --msg-ai-text: #1a202c;

            --radius: 12px;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-depth: inset 0 2px 4px rgba(0,0,0,0.1);

            --sidebar-bg: rgba(255, 255, 255, 0.92);
            --sidebar-hover: rgba(0, 0, 0, 0.05);
            --sidebar-active: rgba(194, 94, 0, 0.15);

            --code-bg: #edf2f7;
            --code-text: #2d3748;
        }

        [data-theme="dark"] {
            /* Dark Wood Theme (Mahogany/Walnut) */
            --primary: #fb923c; /* Orange-400 */
            --primary-hover: #fdba74; /* Orange-300 */
            --bg-wood-start: #2d1b16; /* Very dark brown */
            --bg-wood-end: #1a0f0d;
            --bg-overlay: rgba(0, 0, 0, 0.4);

            --surface: rgba(30, 41, 59, 0.95); /* Slate-800 */
            --surface-secondary: rgba(15, 23, 42, 0.9); /* Slate-900 */

            --text-main: #f1f5f9; /* Slate-100 */
            --text-muted: #94a3b8; /* Slate-400 */
            --border-color: #334155; /* Slate-700 */

            --msg-user-bg: #0369a1; /* Sky-700 */
            --msg-user-text: #f0f9ff;
            --msg-ai-bg: #1e293b; /* Slate-800 */
            --msg-ai-text: #e2e8f0;

            --sidebar-bg: rgba(15, 23, 42, 0.95);
            --sidebar-hover: rgba(255, 255, 255, 0.1);
            --sidebar-active: rgba(251, 146, 60, 0.2);

            --code-bg: #0f172a;
            --code-text: #e2e8f0;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -2px rgba(0, 0, 0, 0.3);
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: var(--bg-wood-start);
            /* Wood texture pattern */
            background-image:
                linear-gradient(335deg, rgba(0,0,0,0.1) 23px, transparent 23px),
                linear-gradient(155deg, rgba(0,0,0,0.1) 23px, transparent 23px),
                linear-gradient(335deg, rgba(0,0,0,0.1) 23px, transparent 23px),
                linear-gradient(155deg, rgba(0,0,0,0.1) 23px, transparent 23px);
            background-size: 58px 58px;
            background-position: 0px 2px, 4px 35px, 29px 31px, 34px 6px;
            background:
                radial-gradient(circle at center, var(--bg-overlay), rgba(0,0,0,0.4)),
                url("https://www.transparenttextures.com/patterns/wood-pattern.png"),
                linear-gradient(to bottom right, var(--bg-wood-start), var(--bg-wood-end));
            transition: background-color 0.3s ease;
            overflow: hidden;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.5; transform: scale(0.95); }
            50% { opacity: 1; transform: scale(1.05); }
        }

        /* Main Container */
        .main-container {
            width: 95%;
            max-width: 1400px;
            height: 90vh;
            display: flex;
            background: var(--surface);
            backdrop-filter: var(--surface-blur);
            -webkit-backdrop-filter: var(--surface-blur);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            border: 1px solid rgba(255, 255, 255, 0.1);
            overflow: hidden;
            transition: background 0.3s ease, color 0.3s ease;
            position: relative;
        }

        /* Sidebar */
        .sidebar {
            width: 260px; /* Default width, will be overridden by inline style */
            min-width: 200px;
            max-width: 400px;
            background: var(--sidebar-bg);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease, width 0.1s ease; /* Fast width transition for drag, smooth for collapse */
            position: relative;
            z-index: 10;
        }

        .sidebar.collapsed {
            width: 0 !important; /* Hide completely */
            min-width: 0;
            overflow: hidden;
            padding: 0;
            border: none;
        }

        .sidebar-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar-header h2 {
            margin: 0;
            font-size: 1.1rem;
            color: var(--text-main);
            font-weight: 600;
        }

        .sidebar-actions {
            display: flex;
            gap: 0.5rem;
        }

        .icon-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 0.4rem;
            border-radius: 6px;
            color: var(--text-muted);
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .icon-btn:hover {
            background: var(--sidebar-hover);
            color: var(--text-main);
        }

        .icon-btn svg {
            width: 18px;
            height: 18px;
            stroke-width: 2;
        }

        .new-session-container {
            padding: 1rem;
        }

        .new-session-btn {
            width: 100%;
            padding: 0.75rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius);
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s ease, transform 0.1s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .new-session-btn:hover {
            background: var(--primary-hover);
            transform: translateY(-1px);
        }

        .new-session-btn:active {
            transform: translateY(0);
        }

        .session-list {
            flex: 1;
            overflow-y: auto;
            padding: 0 0.75rem 1rem 0.75rem;
        }

        /* Custom Scrollbar */
        .session-list::-webkit-scrollbar,
        .messages-container::-webkit-scrollbar {
            width: 6px;
        }
        .session-list::-webkit-scrollbar-track,
        .messages-container::-webkit-scrollbar-track {
            background: transparent;
        }
        .session-list::-webkit-scrollbar-thumb,
        .messages-container::-webkit-scrollbar-thumb {
            background-color: var(--text-muted);
            border-radius: 20px;
            opacity: 0.5;
        }

        .session-item {
            padding: 0.75rem 1rem;
            margin-bottom: 0.25rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--text-main);
            font-size: 0.9rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid transparent;
        }

        .session-item:hover {
            background: var(--sidebar-hover);
        }

        .session-item.active {
            background: var(--sidebar-active);
            color: var(--primary);
            font-weight: 600;
            border-color: rgba(194, 94, 0, 0.1);
        }

        .session-title {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
            margin-right: 0.5rem;
        }

        .session-item input.rename-input {
            width: 100%;
            padding: 4px;
            border: 1px solid var(--primary);
            border-radius: 4px;
            font-size: 0.9rem;
            outline: none;
            background: var(--bg-wood-start); /* fallback */
            background: var(--surface);
            color: var(--text-main);
        }

        /* Resize Handle */
        .resize-handle {
            width: 4px;
            height: 100%;
            background: transparent;
            cursor: col-resize;
            position: absolute;
            right: -2px;
            top: 0;
            z-index: 20;
            transition: background 0.2s;
        }

        .resize-handle:hover,
        .resize-handle.resizing {
            background: var(--primary);
        }

        /* Chat Area */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: rgba(255,255,255,0.02); /* Slight tint */
            position: relative;
            min-width: 300px; /* Prevent total collapse */
        }

        .chat-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            background: var(--surface);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 5;
        }

        .chat-title-group {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .sidebar-toggle-btn {
            background: transparent;
            border: none;
            color: var(--text-main);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sidebar-toggle-btn:hover {
            background: var(--sidebar-hover);
        }

        .chat-header h1 {
            margin: 0;
            font-size: 1.25rem;
            color: var(--text-main);
            font-weight: 700;
        }
        .chat-header .subtitle {
            font-size: 0.8rem;
            color: var(--text-muted);
            display: block;
            margin-top: 2px;
        }

        .header-actions {
            display: flex;
            gap: 0.5rem;
        }

        .messages-container {
            flex: 1;
            padding: 1.5rem 2rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            scroll-behavior: smooth;
        }

        .message {
            max-width: 85%;
            padding: 1rem 1.25rem;
            border-radius: 16px;
            position: relative;
            line-height: 1.6;
            font-size: 0.95rem;
            animation: fadeIn 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .message.user {
            align-self: flex-end;
            background: var(--msg-user-bg);
            color: var(--msg-user-text);
            border-bottom-right-radius: 4px;
        }

        .message.ai {
            align-self: flex-start;
            background: var(--msg-ai-bg);
            color: var(--msg-ai-text);
            border: 1px solid var(--border-color);
            border-bottom-left-radius: 4px;
        }

        .message-content p {
            margin: 0.5rem 0;
        }
        .message-content p:first-child { margin-top: 0; }
        .message-content p:last-child { margin-bottom: 0; }

        /* Markdown Styles */
        .message-content code {
            background: var(--code-bg);
            color: var(--code-text);
            padding: 0.2em 0.4em;
            border-radius: 4px;
            font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
            font-size: 0.9em;
        }

        .message-content pre {
            background: var(--code-bg);
            color: var(--code-text);
            padding: 1rem;
            border-radius: 8px;
            overflow-x: auto;
            margin: 0.5rem 0;
        }

        .message-content pre code {
            background: transparent;
            padding: 0;
            color: inherit;
        }

        .message-content ul, .message-content ol {
            padding-left: 1.5rem;
            margin: 0.5rem 0;
        }

        .message-content blockquote {
            border-left: 4px solid var(--primary);
            margin: 0.5rem 0;
            padding-left: 1rem;
            color: var(--text-muted);
            font-style: italic;
        }

        .message-meta {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 1px solid rgba(0,0,0,0.05);
            padding-top: 0.5rem;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.2rem 0.6rem;
            border-radius: 999px;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .status-accepted { background: #dcfce7; color: #166534; }
        .status-rejected { background: #fee2e2; color: #991b1b; }
        .status-borderline { background: #ffedd5; color: #9a3412; }

        [data-theme="dark"] .status-accepted { background: #064e3b; color: #6ee7b7; }
        [data-theme="dark"] .status-rejected { background: #7f1d1d; color: #fca5a5; }
        [data-theme="dark"] .status-borderline { background: #7c2d12; color: #fdba74; }

        .input-area {
            padding: 1.5rem;
            border-top: 1px solid var(--border-color);
            background: var(--surface);
            display: flex;
            gap: 1rem;
            align-items: center;
            position: relative;
            z-index: 5;
        }

        .chat-input {
            flex: 1;
            padding: 1rem 1.25rem;
            font-size: 1rem;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            outline: none;
            background: var(--surface-secondary);
            color: var(--text-main);
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .chat-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(194, 94, 0, 0.15);
            background: var(--surface);
        }

        .send-btn {
            padding: 0 1.5rem;
            height: 50px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius);
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s, transform 0.1s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .send-btn:hover {
            background: var(--primary-hover);
            transform: translateY(-1px);
        }
        .send-btn:active {
            transform: translateY(0);
        }
        .send-btn:disabled {
            background: var(--text-muted);
            cursor: not-allowed;
            opacity: 0.7;
        }

        /* Typing Indicator */
        .typing-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-style: italic;
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            background: var(--text-muted);
            border-radius: 50%;
            animation: pulse 1.4s infinite ease-in-out both;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        .typing-dot:nth-child(3) { animation-delay: 0s; }

        /* Json Details Toggle */
        .details-toggle {
            background: none;
            border: none;
            color: var(--primary);
            font-size: 0.75rem;
            cursor: pointer;
            text-decoration: none;
            margin-top: 0.5rem;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            transition: background 0.2s;
            display: inline-block;
        }
        .details-toggle:hover {
            background: var(--sidebar-hover);
        }
        .json-details {
            display: none;
            margin-top: 0.5rem;
            padding: 0.75rem;
            background: var(--code-bg);
            border-radius: 6px;
            font-family: 'Menlo', monospace;
            font-size: 0.8rem;
            white-space: pre-wrap;
            overflow-x: auto;
            color: var(--code-text);
            border: 1px solid var(--border-color);
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .main-container {
                width: 100%;
                height: 100vh;
                border-radius: 0;
                border: none;
            }

            .sidebar {
                position: absolute;
                height: 100%;
                z-index: 100;
                transform: translateX(0);
                box-shadow: 5px 0 15px rgba(0,0,0,0.2);
            }

            .sidebar.collapsed {
                width: 260px !important; /* Override the '0' width logic for mobile toggle */
                transform: translateX(-100%); /* Slide out instead of shrink */
                display: flex; /* Keep flex layout */
                overflow: visible;
                border-right: 1px solid var(--border-color);
            }

            .sidebar-overlay {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                z-index: 90;
                opacity: 0;
                pointer-events: none;
                transition: opacity 0.3s;
            }

            .sidebar.mobile-open + .sidebar-overlay {
                opacity: 1;
                pointer-events: auto;
            }

            .resize-handle {
                display: none;
            }

            .message {
                max-width: 90%;
            }

            .messages-container {
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Mobile Overlay -->
    <div class="sidebar-overlay"></div>

    <div class="main-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="resize-handle"></div>

            <div class="sidebar-header">
                <h2>Sessions</h2>
                <div class="sidebar-actions">
                    <button class="icon-btn" id="theme-toggle" title="Toggle Theme">
                        <!-- Sun/Moon Icon -->
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="5"></circle>
                            <line x1="12" y1="1" x2="12" y2="3"></line>
                            <line x1="12" y1="21" x2="12" y2="23"></line>
                            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                            <line x1="1" y1="12" x2="3" y2="12"></line>
                            <line x1="21" y1="12" x2="23" y2="12"></line>
                            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                        </svg>
                    </button>
                    <button class="icon-btn" id="sidebar-toggle" title="Close Sidebar">
                        <!-- Chevron Left -->
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="15 18 9 12 15 6"></polyline>
                        </svg>
                    </button>
                </div>
            </div>

            <div class="new-session-container">
                <button class="new-session-btn" id="new-session-btn">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    <span>New Session</span>
                </button>
            </div>

            <div class="session-list" id="session-list">
                <!-- Sessions populated by JS -->
            </div>
        </div>

        <!-- Chat Area -->
        <div class="chat-area">
            <div class="chat-header">
                <div class="chat-title-group">
                    <button class="sidebar-toggle-btn" onclick="document.querySelector('.sidebar').classList.toggle('collapsed')" title="Toggle Sidebar">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="3" y1="12" x2="21" y2="12"></line>
                            <line x1="3" y1="6" x2="21" y2="6"></line>
                            <line x1="3" y1="18" x2="21" y2="18"></line>
                        </svg>
                    </button>
                    <div>
                        <h1>AILEE Trust Layer</h1>
                        <span class="subtitle">Adaptive Integrity & Trust Validation System</span>
                    </div>
                </div>

                <div class="header-actions">
                    <div class="export-dropdown" style="position: relative;">
                        <button class="icon-btn" id="export-btn" title="Export Chat">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="7 10 12 15 17 10"></polyline>
                                <line x1="12" y1="15" x2="12" y2="3"></line>
                            </svg>
                        </button>
                        <div id="export-menu" style="display: none; position: absolute; right: 0; top: 100%; background: var(--surface); border: 1px solid var(--border-color); border-radius: 8px; padding: 0.5rem; box-shadow: var(--shadow); z-index: 50; min-width: 120px;">
                            <button class="export-option" data-format="json" style="display: block; width: 100%; text-align: left; background: none; border: none; padding: 0.5rem; cursor: pointer; color: var(--text-main);">Export JSON</button>
                            <button class="export-option" data-format="txt" style="display: block; width: 100%; text-align: left; background: none; border: none; padding: 0.5rem; cursor: pointer; color: var(--text-main);">Export TXT</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="messages-container" id="messages-container">
                <!-- Messages populated by JS -->
            </div>

            <div class="input-area">
                <input type="text" class="chat-input" id="chat-input" placeholder="Enter query (e.g. What is the capital of France?)..." autocomplete="off">
                <button class="send-btn" id="send-btn">
                    <span>Send</span>
                    <svg style="margin-left:8px;" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="22" y1="2" x2="11" y2="13"></line>
                        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Script at the end of body -->
    <script>
        /* script.js - Handles Chat Logic */

        class SessionManager {
            constructor() {
                this.sessions = [];
                this.currentSessionId = null;
                this.loadSessions();
            }

            loadSessions() {
                try {
                    const saved = localStorage.getItem('ailee_sessions');
                    if (saved) {
                        this.sessions = JSON.parse(saved);
                    }
                } catch (e) {
                    console.error("Failed to load sessions:", e);
                    this.sessions = [];
                }

                if (this.sessions.length === 0) {
                    this.createNewSession();
                } else {
                    const lastActive = localStorage.getItem('ailee_last_session_id');
                    const session = this.sessions.find(s => s.id === lastActive);
                    this.currentSessionId = session ? session.id : this.sessions[0].id;
                }
            }

            saveSessions() {
                localStorage.setItem('ailee_sessions', JSON.stringify(this.sessions));
                if (this.currentSessionId) {
                    localStorage.setItem('ailee_last_session_id', this.currentSessionId);
                }
            }

            createNewSession() {
                const id = 'sess_' + Date.now();
                const newSession = {
                    id: id,
                    title: 'New Session',
                    messages: [],
                    timestamp: Date.now()
                };
                this.sessions.unshift(newSession);
                this.currentSessionId = id;
                this.saveSessions();
                return newSession;
            }

            getCurrentSession() {
                return this.sessions.find(s => s.id === this.currentSessionId);
            }

            updateSessionTitle(sessionId, newTitle) {
                const session = this.sessions.find(s => s.id === sessionId);
                if (session) {
                    session.title = newTitle.substring(0, 40) + (newTitle.length > 40 ? '...' : '');
                    this.saveSessions();
                }
            }

            renameSession(sessionId, newName) {
                const session = this.sessions.find(s => s.id === sessionId);
                if (session && newName.trim()) {
                    session.title = newName.trim();
                    this.saveSessions();
                    return true;
                }
                return false;
            }

            addMessage(role, content, metadata = null) {
                const session = this.getCurrentSession();
                if (!session) return;

                const message = {
                    role: role,
                    content: content,
                    metadata: metadata,
                    timestamp: Date.now()
                };
                session.messages.push(message);

                // Auto-update title based on last user message
                if (role === 'user') {
                    this.updateSessionTitle(session.id, content);
                }

                this.saveSessions();
                return message;
            }

            switchSession(id) {
                if (this.sessions.some(s => s.id === id)) {
                    this.currentSessionId = id;
                    this.saveSessions();
                    return true;
                }
                return false;
            }

            exportSession(format = 'json') {
                const session = this.getCurrentSession();
                if (!session) return;

                let content = '';
                let mimeType = 'application/json';
                let filename = `session-${session.id}.${format}`;

                if (format === 'json') {
                    content = JSON.stringify(session, null, 2);
                } else {
                    // Text format
                    mimeType = 'text/plain';
                    content = `Session: ${session.title}\nDate: ${new Date(session.timestamp).toLocaleString()}\n\n`;
                    session.messages.forEach(msg => {
                        const role = msg.role.toUpperCase();
                        content += `[${role}]: ${msg.content}\n`;
                        if (msg.role === 'ai' && msg.metadata) {
                            content += `(Trust Score: ${msg.metadata.trust_score}, Status: ${msg.metadata.safety_status})\n`;
                        }
                        content += '-'.repeat(40) + '\n';
                    });
                }

                const blob = new Blob([content], { type: mimeType });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
        }

        class ThemeManager {
            constructor() {
                this.toggleBtn = document.getElementById('theme-toggle');
                this.init();
            }

            init() {
                const savedTheme = localStorage.getItem('ailee_theme') || 'light';
                document.documentElement.setAttribute('data-theme', savedTheme);
                this.updateIcon(savedTheme);

                this.toggleBtn.addEventListener('click', () => {
                    const current = document.documentElement.getAttribute('data-theme');
                    const newTheme = current === 'dark' ? 'light' : 'dark';
                    document.documentElement.setAttribute('data-theme', newTheme);
                    localStorage.setItem('ailee_theme', newTheme);
                    this.updateIcon(newTheme);
                });
            }

            updateIcon(theme) {
                // SVG logic inside button handled by pure HTML/CSS state if needed,
                // or we assume generic icon works for toggle.
            }
        }

        class SidebarManager {
            constructor() {
                this.sidebar = document.querySelector('.sidebar');
                this.handle = document.querySelector('.resize-handle');
                this.toggleBtn = document.getElementById('sidebar-toggle');
                this.isResizing = false;

                this.init();
            }

            init() {
                // Load saved width
                const savedWidth = localStorage.getItem('ailee_sidebar_width');
                if (savedWidth && window.innerWidth > 768) {
                    this.sidebar.style.width = `${savedWidth}px`;
                }

                // Mobile Auto-Collapse on Init
                if (window.innerWidth <= 768) {
                    this.sidebar.classList.add('collapsed');
                }

                // Toggle logic
                this.toggleBtn.addEventListener('click', () => {
                    this.sidebar.classList.toggle('collapsed');
                    if (window.innerWidth <= 768) {
                        this.sidebar.classList.toggle('mobile-open');
                    }
                });

                // Resize logic
                this.handle.addEventListener('mousedown', (e) => {
                    this.isResizing = true;
                    document.body.style.cursor = 'col-resize';
                    this.handle.classList.add('resizing');
                });

                document.addEventListener('mousemove', (e) => {
                    if (!this.isResizing) return;

                    // Constrain width
                    let newWidth = e.clientX;
                    if (newWidth < 200) newWidth = 200;
                    if (newWidth > 500) newWidth = 500;

                    this.sidebar.style.width = `${newWidth}px`;
                });

                document.addEventListener('mouseup', () => {
                    if (this.isResizing) {
                        this.isResizing = false;
                        document.body.style.cursor = '';
                        this.handle.classList.remove('resizing');
                        localStorage.setItem('ailee_sidebar_width', parseInt(this.sidebar.style.width));
                    }
                });
            }
        }

        // Global instances
        const sessionManager = new SessionManager();
        let uiComponents = {};

        document.addEventListener('DOMContentLoaded', () => {
            // Initialize UI Components
            uiComponents.theme = new ThemeManager();
            uiComponents.sidebar = new SidebarManager();

            // DOM Elements
            const sessionList = document.getElementById('session-list');
            const messagesContainer = document.getElementById('messages-container');
            const chatInput = document.getElementById('chat-input');
            const sendBtn = document.getElementById('send-btn');
            const newSessionBtn = document.getElementById('new-session-btn');
            const exportBtn = document.getElementById('export-btn');
            const exportMenu = document.getElementById('export-menu');

            // Initial Render
            renderSidebar();
            renderChat();

            // Event Listeners
            sendBtn.addEventListener('click', sendMessage);

            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });

            newSessionBtn.addEventListener('click', () => {
                sessionManager.createNewSession();
                renderSidebar();
                renderChat();
                if (window.innerWidth <= 768) {
                    document.querySelector('.sidebar').classList.add('collapsed');
                }
            });

            // Export Logic
            exportBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                exportMenu.style.display = exportMenu.style.display === 'block' ? 'none' : 'block';
            });

            document.addEventListener('click', () => {
                if (exportMenu) exportMenu.style.display = 'none';
            });

            document.querySelectorAll('.export-option').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const format = e.target.getAttribute('data-format');
                    sessionManager.exportSession(format);
                });
            });
        });

        function renderSidebar() {
            const sessionList = document.getElementById('session-list');
            sessionList.innerHTML = '';
            const currentId = sessionManager.currentSessionId;

            sessionManager.sessions.forEach(session => {
                const item = document.createElement('div');
                item.className = `session-item ${session.id === currentId ? 'active' : ''}`;

                // Title container
                const titleSpan = document.createElement('span');
                titleSpan.className = 'session-title';
                titleSpan.textContent = session.title || 'New Session';

                // Rename on double click
                titleSpan.addEventListener('dblclick', (e) => {
                    e.stopPropagation(); // Prevent switch
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.className = 'rename-input';
                    input.value = session.title;

                    input.addEventListener('blur', () => {
                        sessionManager.renameSession(session.id, input.value);
                        renderSidebar();
                    });

                    input.addEventListener('keypress', (ev) => {
                        if (ev.key === 'Enter') input.blur();
                    });

                    titleSpan.replaceWith(input);
                    input.focus();
                });

                item.appendChild(titleSpan);

                item.onclick = (e) => {
                    // Don't switch if clicking input
                    if (e.target.tagName === 'INPUT') return;
                    sessionManager.switchSession(session.id);
                    renderSidebar();
                    renderChat();

                    if (window.innerWidth <= 768) {
                        document.querySelector('.sidebar').classList.add('collapsed');
                    }
                };

                sessionList.appendChild(item);
            });
        }

        function renderChat() {
            const messagesContainer = document.getElementById('messages-container');
            messagesContainer.innerHTML = '';
            const session = sessionManager.getCurrentSession();
            if (!session) return;

            session.messages.forEach(msg => {
                appendMessageToUI(msg);
            });
            scrollToBottom();
        }

        function appendMessageToUI(msg, animate = false) {
            const messagesContainer = document.getElementById('messages-container');
            const div = document.createElement('div');
            div.className = `message ${msg.role}`;

            let contentHtml = '';

            // Markdown parsing WITH SANITIZATION
            const rawContent = msg.content;
            let parsedContent;

            if (typeof marked !== 'undefined') {
                const rawMarkdown = marked.parse(rawContent);
                parsedContent = (typeof DOMPurify !== 'undefined')
                    ? DOMPurify.sanitize(rawMarkdown)
                    : rawMarkdown;
            } else {
                parsedContent = escapeHtml(rawContent).replace(/\n/g, '<br>');
            }

            if (msg.role === 'user') {
                contentHtml = `<div class="message-content">${parsedContent}</div>`;
                div.innerHTML = contentHtml;
            } else {
                const meta = msg.metadata || {};
                const status = meta.safety_status || 'UNKNOWN';
                let badgeClass = 'status-borderline';
                if (status === 'ACCEPTED') badgeClass = 'status-accepted';
                if (status === 'OUTRIGHT_REJECTED') badgeClass = 'status-rejected';

                contentHtml = `
                    <div class="message-content">${parsedContent}</div>
                    <div class="message-meta">
                        <span class="status-badge ${badgeClass}">${escapeHtml(status)}</span>
                        <span>Score: ${meta.trust_score !== undefined ? Number(meta.trust_score).toFixed(1) : 'N/A'}</span>
                    </div>
                    <button class="details-toggle" onclick="var d = this.nextElementSibling; d.style.display = d.style.display === 'block' ? 'none' : 'block'">Details</button>
                    <div class="json-details" style="display:none;">${escapeHtml(JSON.stringify(meta, null, 2))}</div>
                `;
                div.innerHTML = contentHtml;
            }

            messagesContainer.appendChild(div);
            return div;
        }

        async function sendMessage() {
            const chatInput = document.getElementById('chat-input');
            const sendBtn = document.getElementById('send-btn');
            const messagesContainer = document.getElementById('messages-container');

            const text = chatInput.value.trim();
            if (!text) return;

            chatInput.value = '';
            chatInput.disabled = true;
            sendBtn.disabled = true;

            // Add User Message
            const userMsg = sessionManager.addMessage('user', text);
            appendMessageToUI(userMsg, true);
            scrollToBottom();
            renderSidebar();

            // Add Typing Indicator
            const loadingId = 'loading-' + Date.now();
            const loadingDiv = document.createElement('div');
            loadingDiv.id = loadingId;
            loadingDiv.className = 'message ai typing-indicator-container';
            loadingDiv.innerHTML = `
                <span class="typing-indicator">
                    AILEE is thinking
                    <span class="typing-dot"></span>
                    <span class="typing-dot"></span>
                    <span class="typing-dot"></span>
                </span>`;
            messagesContainer.appendChild(loadingDiv);
            scrollToBottom();

            try {
                const response = await fetch(`/trust?query=${encodeURIComponent(text)}&format=json`);

                // Remove loading
                const loadingEl = document.getElementById(loadingId);
                if (loadingEl) loadingEl.remove();

                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }

                const data = await response.json();
                const content = data.trusted_answer || "No answer generated.";

                // Add AI Message to data
                const aiMsg = sessionManager.addMessage('ai', content, data);

                // Streaming Effect Simulation
                const msgDiv = document.createElement('div');
                msgDiv.className = 'message ai';
                messagesContainer.appendChild(msgDiv);

                const meta = data || {};
                const status = meta.safety_status || 'UNKNOWN';
                let badgeClass = 'status-borderline';
                if (status === 'ACCEPTED') badgeClass = 'status-accepted';
                if (status === 'OUTRIGHT_REJECTED') badgeClass = 'status-rejected';

                let i = 0;
                const speed = 10;

                // Create container structure
                msgDiv.innerHTML = `
                    <div class="message-content"></div>
                    <div class="message-meta" style="opacity:0; transition:opacity 0.5s">
                        <span class="status-badge ${badgeClass}">${escapeHtml(status)}</span>
                        <span>Score: ${meta.trust_score !== undefined ? Number(meta.trust_score).toFixed(1) : 'N/A'}</span>
                    </div>
                    <button class="details-toggle" style="opacity:0; transition:opacity 0.5s" onclick="var d = this.nextElementSibling; d.style.display = d.style.display === 'block' ? 'none' : 'block'">Details</button>
                    <div class="json-details" style="display:none;">${escapeHtml(JSON.stringify(meta, null, 2))}</div>
                `;

                const contentDiv = msgDiv.querySelector('.message-content');

                function typeWriter() {
                    if (i < content.length) {
                        const chunk = content.substring(i, i + 3);
                        i += 3;
                        contentDiv.textContent += chunk;
                        scrollToBottom();
                        setTimeout(typeWriter, speed);
                    } else {
                        // Done typing: Parse Markdown + SANITIZE
                        if (typeof marked !== 'undefined') {
                            const rawMarkdown = marked.parse(content);
                            const safeMarkdown = (typeof DOMPurify !== 'undefined')
                                ? DOMPurify.sanitize(rawMarkdown)
                                : rawMarkdown;
                            contentDiv.innerHTML = safeMarkdown;
                        }
                        msgDiv.querySelector('.message-meta').style.opacity = 1;
                        msgDiv.querySelector('.details-toggle').style.opacity = 1;
                        scrollToBottom();
                    }
                }

                typeWriter();

            } catch (error) {
                const loadingEl = document.getElementById(loadingId);
                if (loadingEl) loadingEl.remove();

                const errorMsg = sessionManager.addMessage('ai', "Error: " + error.message, { safety_status: 'ERROR' });
                appendMessageToUI(errorMsg);
            } finally {
                chatInput.disabled = false;
                sendBtn.disabled = false;
                chatInput.focus();
            }
        }

        function scrollToBottom() {
            const messagesContainer = document.getElementById('messages-container');
            if (messagesContainer) {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        }

        function escapeHtml(text) {
            if (!text) return '';
            return String(text)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
    </script>
</body>
</html>
